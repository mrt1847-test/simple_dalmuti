<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‹¬ë¬´í‹° ê²Œì„</title>
  <style>
    body { display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f5dc; }
    #mainWrap { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; }
    #gameArea { min-width: 420px; }
    #chatWrap { width: 260px; margin-left: 2em; background: #fff; border-radius: 10px; box-shadow: 0 1px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; height: 540px; }
    #chatMessages { flex: 1; overflow-y: auto; padding: 1em; font-size: 1em; }
    #chatInputWrap { display: flex; border-top: 1px solid #eee; }
    #chatInput { flex: 1 1 auto; min-width: 0; border: none; padding: 0.7em; font-size: 1em; border-radius: 0 0 0 10px; }
    #chatSend { width: 56px; border: none; background: #8bc34a; color: #fff; font-size: 1em; border-radius: 0 0 10px 0; cursor: pointer; }
    #chatSend:hover { background: #689f38; }
  </style>
</head>
<body>
  <div id="mainWrap">
    <div id="gameArea">
      <h1 style="text-align:center;">ë‹¬ë¬´í‹° ê²Œì„</h1>
      <div id="gameContent"></div>
    </div>
    <div id="chatWrap">
      <div id="chatMessages"></div>
      <div id="chatInputWrap">
        <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off" />
        <button id="chatSend">ì „ì†¡</button>
      </div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    console.log('game.html loaded');
    document.addEventListener('DOMContentLoaded', function() {
      const nickname = localStorage.getItem('dalmuti_nickname');
      if (!nickname) window.location.href = '/index.html';

      const socket = io();
      socket.on('connect', () => {
        console.log('socket connected! id:', socket.id);
      });
      socket.on('roleAssigned', (ordered) => {
        console.log('roleAssigned:', ordered, 'ë‚´ ì†Œì¼“ id:', socket.id);
      });

      // â˜… ì„œë²„ì— ë‹‰ë„¤ì„ì„ ì•Œë¦¼
      socket.emit('join', nickname, (res) => {
        if (!res.success && res.message !== 'ì¤‘ë³µ ë‹‰ë„¤ì„') {
          alert(res.message);
          window.location.href = '/index.html';
        }
      });

      // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
      let myCards = [];
      let selected = [];
      let myIdx = null;
      let turnInfo = null;
      let field = null;
      let ordered = [];
      console.log('roleAssigned:', ordered);
      // ì‹ ë¶„ ë° ìë¦¬ ë°°ì • ê²°ê³¼(ì›í˜• í…Œì´ë¸”)
      socket.on('roleAssigned', (ordered) => {
        console.log('roleAssigned:', ordered, 'ë‚´ ì†Œì¼“ id:', socket.id);
        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;
        console.log('roleAssigned:', ordered);
        const n = ordered.length;
        const radius = 160;
        let html = '<h1 style="text-align:center;">ì‹ ë¶„ ë° ìë¦¬ ë°°ì • ê²°ê³¼</h1>';
        html += '<div style="position:relative;width:400px;height:400px;margin:0 auto;background:#f5f5dc;border-radius:50%;box-shadow:0 2px 12px rgba(0,0,0,0.08);">';
        ordered.forEach((p, i) => {
          const angle = (2 * Math.PI * i) / n - Math.PI/2;
          const x = 200 + radius * Math.cos(angle) - 60;
          const y = 200 + radius * Math.sin(angle) - 40;
          html += `<div style="position:absolute;left:${x}px;top:${y}px;width:120px;height:80px;text-align:center;background:white;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,0.08);padding:0.5em 0.2em;display:flex;flex-direction:column;justify-content:center;align-items:center;">
            <div style='font-weight:bold;font-size:1.1em;'>${p.role}</div>
            <div style='margin:0.2em 0;'>${p.nickname}</div>
            <div style='font-size:0.9em;color:#888;'>ì¹´ë“œ: ${p.card}</div>
          </div>`;
        });
        html += '<div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:1.3em;font-weight:bold;">ë‹¬ë¬´í‹°<br>í…Œì´ë¸”</div>';
        html += '</div>';
        gameContent.innerHTML = html;
      });

      // ë‚´ ì¹´ë“œ í‘œì‹œ ë° ì¹´ë“œ ì œì¶œ/íŒ¨ìŠ¤ UI
      function renderHand() {
        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;
        let html = '<h1 style="text-align:center;">ë‚´ ì¹´ë“œ</h1>';
        if (field && field.cards) {
          html += '<div style="text-align:center;margin-bottom:1em;">';
          html += `<b>í•„ë“œ:</b> ${field.cards.map(c => c==='J'?'ğŸƒ':c).join(' ')} (${field.count}ì¥, ${field.number} ì´í•˜ë§Œ ê°€ëŠ¥)`;
          html += '</div>';
        }
        html += '<div id="handArea" style="display:flex;flex-wrap:wrap;justify-content:center;gap:0.5em 0.3em;">';
        myCards.forEach((card, i) => {
          const isSelected = selected.includes(i);
          html += `<div class="cardBtn" data-idx="${i}" style="width:48px;height:72px;background:${isSelected ? '#ffe082' : '#fffbe6'};border:2px solid ${isSelected ? '#ff9800' : '#bdb76b'};border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.3em;font-weight:bold;box-shadow:0 1px 4px rgba(0,0,0,0.08);cursor:pointer;">${card === 'J' ? 'ğŸƒ' : card}</div>`;
        });
        html += '</div>';
        html += '<div style="text-align:center;margin-top:1.5em;">';
        html += '<button id="submitBtn" style="padding:0.7em 2em;font-size:1.1em;margin-right:1em;">ì œì¶œ</button>';
        html += '<button id="passBtn" style="padding:0.7em 2em;font-size:1.1em;">íŒ¨ìŠ¤</button>';
        html += '</div>';
        gameContent.innerHTML = html;

        // ì¹´ë“œ ì„ íƒ
        document.querySelectorAll('.cardBtn').forEach(btn => {
          btn.onclick = function() {
            const idx = parseInt(this.getAttribute('data-idx'));
            if (selected.length === 0) {
              selected.push(idx);
            } else {
              const firstCard = myCards[selected[0]];
              if (selected.includes(idx)) {
                selected = selected.filter(i => i !== idx);
              } else if (myCards[idx] === firstCard) {
                selected.push(idx);
              } else {
                alert('ê°™ì€ ìˆ«ìë§Œ ì—¬ëŸ¬ ì¥ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
              }
            }
            renderHand();
          };
        });
        // ì œì¶œ ë²„íŠ¼
        document.getElementById('submitBtn').onclick = function() {
          if (turnInfo && turnInfo.turnIdx !== myIdx) {
            alert('ì•„ì§ ë‚´ ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤!');
            return;
          }
          if (selected.length === 0) {
            alert('ì œì¶œí•  ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
            return;
          }
          const cards = selected.map(i => myCards[i]);
          socket.emit('playCards', cards, (res) => {
            if (res && !res.success) {
              alert(res.message);
            }
          });
        };
        // íŒ¨ìŠ¤ ë²„íŠ¼
        document.getElementById('passBtn').onclick = function() {
          if (turnInfo && turnInfo.turnIdx !== myIdx) {
            alert('ì•„ì§ ë‚´ ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤!');
            return;
          }
          socket.emit('passTurn');
        };
      }
      socket.on('dealCards', (cards) => {
        myCards = cards;
        selected = [];
        renderHand();
      });

      // í„´ ì •ë³´, ì œì¶œ/íŒ¨ìŠ¤ ê²°ê³¼, ìƒˆ ë¼ìš´ë“œ ë“±ì€ í•„ìš”ì— ë”°ë¼ ì¶”ê°€ êµ¬í˜„
      // ... (ì´ì „ index.htmlì˜ ê²Œì„ ê´€ë ¨ socket.on ì´ë²¤íŠ¸ë¥¼ ì°¸ê³ í•´ ì¶”ê°€ êµ¬í˜„ ê°€ëŠ¥) ...

      // ê²Œì„ ì‹œì‘ ì•Œë¦¼
      socket.on('gameStarted', (data) => {
        console.log('ê²Œì„ ì‹œì‘:', data);
        turnInfo = data;
        myIdx = ordered.findIndex(p => p.id === socket.id);
        
        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;
        
        let html = '<h1 style="text-align:center;">ê²Œì„ ì‹œì‘!</h1>';
        html += `<div style="text-align:center;margin-bottom:1em;font-size:1.2em;">`;
        html += `í˜„ì¬ ì°¨ë¡€: <b>${data.currentPlayer.nickname}</b> (${data.currentPlayer.role})`;
        html += '</div>';
        
        if (data.currentPlayer.id === socket.id) {
          html += '<div style="text-align:center;color:#4caf50;font-weight:bold;margin-bottom:1em;">ğŸ¯ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!</div>';
        }
        
        gameContent.innerHTML = html;
        renderHand();
      });

      // ì°¨ë¡€ ë³€ê²½ ì•Œë¦¼
      socket.on('turnChanged', (data) => {
        console.log('ì°¨ë¡€ ë³€ê²½:', data);
        turnInfo = data;
        
        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;
        
        let html = '<h1 style="text-align:center;">ì°¨ë¡€ ë³€ê²½</h1>';
        html += `<div style="text-align:center;margin-bottom:1em;font-size:1.2em;">`;
        html += `í˜„ì¬ ì°¨ë¡€: <b>${data.currentPlayer.nickname}</b> (${data.currentPlayer.role})`;
        html += '</div>';
        
        if (data.currentPlayer.id === socket.id) {
          html += '<div style="text-align:center;color:#4caf50;font-weight:bold;margin-bottom:1em;">ğŸ¯ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!</div>';
        }
        
        gameContent.innerHTML = html;
        renderHand();
      });

      // ì¹´ë“œ ì œì¶œ ê²°ê³¼
      socket.on('playResult', (data) => {
        console.log('ì¹´ë“œ ì œì¶œ ê²°ê³¼:', data);
        const player = ordered[data.playerIdx];
        const cards = data.cards.map(c => c === 'J' ? 'ğŸƒ' : c).join(' ');
        
        // í•„ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
        if (data.lastPlay) {
          field = {
            cards: data.cards,
            count: data.lastPlay.count,
            number: data.lastPlay.number
          };
        }
        
        // ì™„ì£¼í•œ í”Œë ˆì´ì–´ ì²´í¬
        if (data.finished[data.playerIdx]) {
          appendChat(`ğŸ ${player.nickname}ë‹˜ì´ ì™„ì£¼í–ˆìŠµë‹ˆë‹¤!`, false);
        }
        
        appendChat(`ğŸ´ ${player.nickname}ë‹˜ì´ ${cards}ë¥¼ ëƒˆìŠµë‹ˆë‹¤.`, false);
        renderHand();
      });

      // íŒ¨ìŠ¤ ê²°ê³¼
      socket.on('passResult', (data) => {
        console.log('íŒ¨ìŠ¤ ê²°ê³¼:', data);
        const player = ordered[data.playerIdx];
        appendChat(`â­ï¸ ${player.nickname}ë‹˜ì´ íŒ¨ìŠ¤í–ˆìŠµë‹ˆë‹¤. (${data.passes}ë²ˆì§¸ íŒ¨ìŠ¤)`, false);
      });

      // ìƒˆë¡œìš´ ë¼ìš´ë“œ ì‹œì‘
      socket.on('newRound', (data) => {
        console.log('ìƒˆ ë¼ìš´ë“œ:', data);
        turnInfo = data;
        field = null; // í•„ë“œ ì´ˆê¸°í™”
        
        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;
        
        let html = '<h1 style="text-align:center;">ìƒˆ ë¼ìš´ë“œ ì‹œì‘!</h1>';
        html += `<div style="text-align:center;margin-bottom:1em;font-size:1.2em;">`;
        html += `ì‹œì‘: <b>${data.currentPlayer.nickname}</b> (${data.currentPlayer.role})`;
        html += '</div>';
        
        if (data.currentPlayer.id === socket.id) {
          html += '<div style="text-align:center;color:#4caf50;font-weight:bold;margin-bottom:1em;">ğŸ¯ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!</div>';
        }
        
        gameContent.innerHTML = html;
        renderHand();
      });

      // ê²Œì„ ì¢…ë£Œ ë° ì ìˆ˜
      socket.on('gameEnd', (result) => {
        console.log('ê²Œì„ ì¢…ë£Œ:', result);
        
        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;
        
        let html = '<h1 style="text-align:center;">ê²Œì„ ì¢…ë£Œ!</h1>';
        html += '<div style="text-align:center;margin-bottom:2em;">';
        html += '<h2>ğŸ† ì™„ì£¼ ìˆœì„œ</h2>';
        result.forEach((player, i) => {
          const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ…';
          html += `<div style="margin:0.5em 0;font-size:1.1em;">`;
          html += `${medal} ${i+1}ìœ„: ${player.nickname} (${player.role}) - ${player.score}ì  (ì´ì : ${player.total}ì )`;
          html += '</div>';
        });
        html += '</div>';
        
        gameContent.innerHTML = html;
        
        // ì±„íŒ…ì—ë„ ê²°ê³¼ ì•Œë¦¼
        appendChat('ğŸ‰ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', false);
        result.forEach((player, i) => {
          const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ…';
          appendChat(`${medal} ${i+1}ìœ„: ${player.nickname} (${player.role}) - ${player.score}ì `, false);
        });
      });

      // ìµœì¢… ê²°ê³¼ (5íŒ ì™„ë£Œ)
      socket.on('finalResult', (result) => {
        console.log('ìµœì¢… ê²°ê³¼:', result);
        
        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;
        
        let html = '<h1 style="text-align:center;">ğŸŠ ìµœì¢… ê²°ê³¼ ğŸŠ</h1>';
        html += '<div style="text-align:center;margin-bottom:2em;">';
        html += '<h2>ğŸ† ìµœì¢… ìš°ìŠ¹ì</h2>';
        result.forEach((player, i) => {
          const medal = i === 0 ? 'ğŸ‘‘' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ…';
          html += `<div style="margin:0.5em 0;font-size:1.1em;">`;
          html += `${medal} ${i+1}ìœ„: ${player.nickname} - ${player.score}ì `;
          html += '</div>';
        });
        html += '</div>';
        html += '<div style="text-align:center;">';
        html += '<button onclick="location.reload()" style="padding:1em 2em;font-size:1.2em;background:#4caf50;color:white;border:none;border-radius:8px;cursor:pointer;">ìƒˆ ê²Œì„ ì‹œì‘</button>';
        html += '</div>';
        
        gameContent.innerHTML = html;
        
        // ì±„íŒ…ì—ë„ ìµœì¢… ê²°ê³¼ ì•Œë¦¼
        appendChat('ğŸŠ 5íŒ ì™„ë£Œ! ìµœì¢… ê²°ê³¼ì…ë‹ˆë‹¤!', false);
        result.forEach((player, i) => {
          const medal = i === 0 ? 'ğŸ‘‘' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ…';
          appendChat(`${medal} ${i+1}ìœ„: ${player.nickname} - ${player.score}ì `, false);
        });
      });

      // ì±„íŒ… ê¸°ëŠ¥
      const chatMessages = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');
      function appendChat(msg, isMine) {
        const div = document.createElement('div');
        div.textContent = msg;
        div.style.margin = '0.2em 0';
        if (isMine) div.style.textAlign = 'right';
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      chatSend.onclick = sendChat;
      chatInput.onkeydown = function(e) { if (e.key === 'Enter') sendChat(); };
      function sendChat() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        socket.emit('chat', msg);
        appendChat(`ë‚˜: ${msg}`, true);
        chatInput.value = '';
      }
      socket.on('chat', (msg) => {
        console.log('chat:', msg, 'ë‚´ ì†Œì¼“ id:', socket.id);
        appendChat(`${nickname}: ${msg}`);
      });

      // 1~12 ì¤‘ 6ê°œ ìˆ«ì ì¤‘ ë‚´ ìˆ«ì ë³´ì—¬ì£¼ê¸°
      socket.on('showNumber', (num) => {
        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;
        gameContent.innerHTML = `<div style="text-align:center;font-size:2em;margin-top:2em;">ë‹¹ì‹ ì˜ ìˆ«ì: <b>${num}</b></div>`;
      });

      function startGameIfReady() {
        // ... ê¸°ì¡´ ì½”ë“œ ...
        if (players.length > 1 && players.length <= MAX_PLAYERS && players.every(p => p.ready)) {
          // ... ê¸°ì¡´ ì½”ë“œ ...
          // ì‹ ë¶„ ë°°ì •
          let picked = players.map((p, i) => ({ id: p.id, nickname: p.nickname, card: numbers[i] }));
          const roles = ['ë‹¬ë¬´í‹°', 'ëŒ€ì£¼êµ', 'í‰ë¯¼', 'í‰ë¯¼', 'ê´‘ë¶€', 'ë…¸ì˜ˆ'];
          picked.sort((a, b) => a.card - b.card);
          ordered = picked.map((p, i) => ({ ...p, role: roles[i] }));
          io.emit('roleAssigned', ordered);
          // ì´í›„ ê²Œì„ ë¡œì§ì—ì„œ ordered ì‚¬ìš©
        }
      }
    });
  </script>
</body>
</html> 