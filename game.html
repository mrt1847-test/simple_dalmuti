<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‹¬ë¬´í‹° ê²Œì„</title>
  <style>
    html, body {
      height: auto;
      min-height: 100vh;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: auto;
      min-height: 100vh;
      background: #f5f5dc;
      overflow-y: auto;
    }
    #mainWrap {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
      width: 100%;
    }
    #gameArea {
      min-width: 420px;
      max-width: 90vw;
    }
    #chatWrap {
      width: 380px;
      min-width: 300px;
      margin-left: 3em;
      margin-right: 2vw;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      height: 540px;
    }
    #chatMessages { flex: 1; overflow-y: auto; padding: 1em; font-size: 1em; display: flex; flex-direction: column; }
    #chatInputWrap { display: flex; border-top: 1px solid #eee; }
    #chatInput { flex: 1 1 auto; min-width: 0; border: none; padding: 0.7em; font-size: 1em; border-radius: 0 0 0 10px; }
    #chatSend { width: 56px; border: none; background: #8bc34a; color: #fff; font-size: 1em; border-radius: 0 0 10px 0; cursor: pointer; }
    #chatSend:hover { background: #689f38; }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
      body { height: auto; min-height: 100vh; padding: 10px; }
      #mainWrap { flex-direction: column; align-items: center; flex-wrap: nowrap; padding-bottom: 33vh; }
      #gameArea { min-width: auto; width: 100%; max-width: 400px; }
      
      /* ê²Œì„ ë‚˜ê°€ê¸° ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
      #leaveGameBtn {
        padding: 10px 16px !important;
        font-size: 16px !important;
        min-height: 44px !important;
        background: #e57373 !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
      }
      
      /* ë„ì›€ë§ ë²„íŠ¼ ëª¨ë°”ì¼ ìµœì í™” */
      #helpBtn {
        padding: 10px 16px !important;
        font-size: 16px !important;
        min-height: 44px !important;
      }
      
      #chatWrap {
        display: flex !important;
        position: fixed;
        left: 0;
        bottom: 0;
        width: 100vw;
        height: 33vh;
        min-height: 220px;
        max-height: 60vh;
        background: #fff;
        z-index: 2100;
        box-shadow: 0 -2px 16px rgba(0,0,0,0.18);
        border-radius: 16px 16px 0 0;
        flex-direction: column;
        justify-content: flex-end;
        transition: none;
        margin: 0;
      }
      
      /* íƒ€ì´í‹€ê³¼ ì›íƒ ì‚¬ì´ ê°„ê²© ì¡°ì • */
      h1 { margin-bottom: 1.5em !important; }
      
      /* í„´ ì •ë³´ì™€ ì›íƒ ì‚¬ì´ ê°„ê²© ì¡°ì • */
      #gameContent > div:nth-child(2) { margin-top: 3.5em !important; }
      
      /* í”Œë ˆì´ì–´ ì¹´ë“œ í°íŠ¸ í¬ê¸° ì¡°ì • */
      .player-card div { font-size: 0.8em !important; }
      
      /* ì¹´ë“œ í¬ê¸° ì¡°ì • */
      .cardBtn > div { width: 60px !important; height: 90px !important; font-size: 1.5em !important; }
      
      /* í•¸ë“œ ì¹´ë“œ ì˜ì—­ ìµœì í™” - 8ì¥ ì´ìƒì¼ ë•Œ ë‘ ì¤„ë¡œ */
      #handArea { 
        flex-wrap: wrap !important; 
        justify-content: center !important; 
        gap: 5px !important;
        max-width: 400px !important;
      }
      
      /* í•„ë“œ ì¹´ë“œ í¬ê¸° ì¡°ì • */
      #gameContent div[style*="width:80px;height:130px"] { width: 60px !important; height: 90px !important; }
      #helpModal > div {
        max-width: 95vw !important;
        width: 95vw !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
        box-sizing: border-box;
      }
      /* ëª¨ë°”ì¼ìš© í”Œë¡œíŒ… ë²„íŠ¼, ëª¨ë°”ì¼ ì „ìš© ì±„íŒ…ì°½ ìˆ¨ê¹€ */
      #mobileChatBtn, #mobileChatWrap { display: none !important; }
    }

    /* ì‘ì€ ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 480px) {
      #gameArea { max-width: 100%; }
      #chatWrap { max-width: 100%; }
      
      /* íƒ€ì´í‹€ê³¼ ì›íƒ ì‚¬ì´ ê°„ê²© ë” ì¡°ì • */
      h1 { margin-bottom: 1em !important; }
      
      /* í„´ ì •ë³´ì™€ ì›íƒ ì‚¬ì´ ê°„ê²© ë” ì¡°ì • */
      #gameContent > div:nth-child(2) { margin-top: 3.5em !important; }
      
      /* í”Œë ˆì´ì–´ ì¹´ë“œ í°íŠ¸ í¬ê¸° ë” ì‘ê²Œ */
      .player-card div { font-size: 0.7em !important; }
      
      /* ì¹´ë“œ ë” ì‘ê²Œ */
      .cardBtn > div { width: 50px !important; height: 75px !important; font-size: 1.2em !important; }
      
      /* í•¸ë“œ ì¹´ë“œ ì˜ì—­ ë” ì‘ì€ í™”ë©´ì—ì„œ ìµœì í™” */

      
      /* í•„ë“œ ì¹´ë“œ ë” ì‘ê²Œ */
      #gameContent div[style*="width:80px;height:130px"] { width: 50px !important; height: 75px !important; }
      #helpModal > div {
        max-width: 98vw !important;
        width: 98vw !important;
        max-height: 90vh !important;
        overflow-y: auto !important;
        box-sizing: border-box;
      }
    }

    /* ì±„íŒ… ë§í’ì„  ìŠ¤íƒ€ì¼ */
    .chat-bubble {
      display: inline-block;
      padding: 0.5em 1em;
      border-radius: 18px;
      margin: 0.2em 0;
      max-width: 80%;
      word-break: break-all;
      font-size: 1em;
      position: relative;
    }
    .chat-bubble.user {
      background: #e0f7fa;
      color: #222;
      text-align: left;
      margin-left: 1em;
      align-self: flex-start;
    }
    .chat-bubble.mine {
      background: #ffd180;
      color: #222;
      text-align: right;
      margin-right: 1em;
      align-self: flex-end;
    }
    .chat-bubble.system {
      background: #f5f5f5;
      color: #888;
      text-align: center;
      font-style: italic;
      margin: 0.5em auto;
      align-self: center;
    }
    #handArea {
      display: flex;
      background: #eee;
      padding: 10px;
      box-sizing: border-box;
      margin: 0 auto 10px auto;
      overflow: visible;
    }
    @media (max-width: 900px) {
      #mainWrap { flex-direction: column; justify-content: center; }
      #chatWrap { margin-right: 0; margin-left: 0; max-width: 100%; min-width: 0; }
      #gameArea { max-width: 90vw; min-width: 0; }
    }
  </style>
</head>
<body>
  <div id="mainWrap">
    <div id="gameArea">
      <div style="text-align:right; margin-bottom: 0.5em;">
        <button id="helpBtn" style="padding:0.5em 1.2em;font-size:1em;background:#8bc34a;color:white;border:none;border-radius:8px;cursor:pointer;margin-right:0.5em;">ê²Œì„ë£°</button>
        <button id="leaveGameBtn" style="padding:0.5em 1.2em;font-size:1em;background:#e57373;color:white;border:none;border-radius:8px;cursor:pointer;">ê²Œì„ ë‚˜ê°€ê¸°</button>
      </div>
      <h1 style="text-align:center;margin-bottom:2em;">ë‹¬ë¬´í‹° ê²Œì„</h1>
      <div id="gameContent"></div>
    </div>
    <div id="chatWrap">
      <div id="chatMessages"></div>
      <div id="chatInputWrap">
        <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off" />
        <button id="chatSend">ì „ì†¡</button>
      </div>
    </div>
  </div>
  <div id="helpModal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);justify-content:center;align-items:center;">
    <div style="background:#fff;padding:2em 1.5em 1.5em 1.5em;border-radius:12px;max-width:400px;box-shadow:0 2px 16px rgba(0,0,0,0.18);position:relative;">
      <button id="closeHelp" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.3em;cursor:pointer;color:#888;">âœ•</button>
      <h2 style="margin-top:0;">ê²Œì„ ë„ì›€ë§</h2>
      <ul style="font-size:1em;line-height:1.7;margin-bottom:1em;">
        <li>ìµœì†Œ 4ëª…, ìµœëŒ€ 8ëª…ê¹Œì§€ ì°¸ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li>ê³„ê¸‰ì— ë”°ë¼ ìƒˆë¡­ê²Œ ìë¦¬ë¥¼ ë°°ì¹˜í•œë‹¤. </li>
        <li>ê° ê³„ê¸‰ì€ ìì‹ ë³´ë‹¤ ë‚®ì€ ê³„ê¸‰ì—ê²Œ ì´ê²ƒì €ê²ƒ ì‹œí‚¬ ìˆ˜ ìˆë‹¤. ê±°ë¶€ê¶Œì€ ì—†ë‹¤.</li>
        <li>ë†ë…¸ëŠ” ì™•ì—ê²Œ ìì‹ ì˜ ì¹´ë“œë“¤ ì¤‘ ì íŒ ìˆ˜ê°€ ê°€ì¥ ì‘ì€ ì¹´ë“œ 2ì¥ì„ ì™•ì—ê²Œ ì¡°ê³µìœ¼ë¡œ ë°”ì¹œë‹¤. ë¬¼ë¡  ê³µì†í•˜ê²Œ.</li>
        <li>ì™•ì€ ìì‹ ì—ê²Œ ê°€ì¥ ì“¸ëª¨ì—†ì„ ê²ƒ ê°™ì€ ì¹´ë“œ 2ì¥ì„ ë†ë…¸ì—ê²Œ ì¤€ë‹¤.</li>
        <li>ê´‘ë¶€ëŠ” ëŒ€ì£¼êµì—ê²Œ ë†ë…¸ì™€ ê°™ì€ ë°©ì‹ìœ¼ë¡œ 1ì¥ì„ ì¡°ê³µìœ¼ë¡œ ë°”ì¹˜ê³  ëŒ€ì£¼êµëŠ” ì™•ê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ 1ì¥ì„ ì¤€ë‹¤.</li>
        <li>ì™•ë¶€í„° ì‹œê³„ë°©í–¥ìœ¼ë¡œ ëŒì•„ê°€ë©´ì„œ ì¹´ë“œë¥¼ ë‚´ëŠ”ë° ê·œì¹™ì´ ìˆë‹¤.</li>
        <li>ë§¨ ì²˜ìŒ í”Œë ˆì´ì–´ê°€ ë‚¸ ì¹´ë“œì˜ ê°œìˆ˜ë§Œí¼ë§Œ ë‚¼ ìˆ˜ ìˆë‹¤.</li>  
        <li>ë°”ë¡œ ì „ í”Œë ˆì´ì–´ê°€ ë‚¸ ì¹´ë“œì— ì í˜€ìˆëŠ” ìˆ˜ë³´ë‹¤ ë‚®ì€ ìˆ˜ì˜ ì¹´ë“œë§Œ ë‚¼ ìˆ˜ ìˆë‹¤.</li>
        <li>ë§Œì•½ ì¹´ë“œë¥¼ ë‚¼ ìˆ˜ ì—†ë‹¤ë©´ íŒ¨ìŠ¤ë¥¼ ì„ ì–¸í•œë‹¤.</li>
        <li>íŒ¨ìŠ¤ê°€ ê³„ì† ì„ ì–¸ë˜ì–´ì„œ í•œë°”í€´ê°€ ëŒì•„ì„œ ë§¨ ë§ˆì§€ë§‰ ì¹´ë“œë¥¼ ë‚¸ í”Œë ˆì´ì–´ì˜ ì°¨ë¡€ê°€ ë˜ë©´ ê·¸ í”Œë˜ì´ì–´ê°€ ì„ ìœ¼ë¡œ ìƒˆë¡œìš´ ë¼ìš´ë“œë¥¼ ì‹œì‘í•œë‹¤.</li>
        <li>ìœ„ì˜ ê³¼ì •ì„ ë°˜ë³µí•´ì„œ ì¹´ë“œë¥¼ ë§¨ ì²˜ìŒ ë‹¤ í„¸ì–´ë²„ë¦¬ëŠ” ìˆœì„œë¡œ ì ìˆ˜ê°€ ë¶€ì—¬ëœë‹¤</li>
        <li>ë‹¤ìŒ ê²Œì„ì€ ì „ ê²Œì„ì˜ ìˆœìœ„ë¡œ ì‹ ë¶„ì´ ë°°ì •ëœë‹¤.</li>
        <li>ìµœì´ˆ ì¹´ë“œ ë°°ë¶„ì‹œ ì¡°ì»¤ 2ì¥ ë³´ìœ ì‹œ í˜ëª… ì—¬ë¶€ ì„ íƒê°€ëŠ¥</li>
        <li>í˜ëª… ì‹œ ì¹´ë“œêµí™˜ ë‹¨ê³„ ìƒëµ</li>
        <li>ì¬ë°Œê²Œ ì¦ê¸°ì…¨ìœ¼ë©´ ì»¤í”¼ í•œì” ì‚¬ì£¼ê¸°</li>
      </ul>
      <div style="font-size:0.95em;color:#888;">íŒ: <b>!íƒ€ì´ë¨¸on</b> / <b>!íƒ€ì´ë¨¸off</b>ë¥¼ ì±„íŒ…ì— ì…ë ¥í•´ íƒ€ì´ë¨¸ë¥¼ ì œì–´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><b>!íƒ€ì´ë¨¸ 20</b> / <b>!íƒ€ì´ë¨¸ 60</b>ìœ¼ë¡œ íƒ€ì´ë¨¸ ì‹œê°„ì„ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br><b>!ìŠ¤ì½”ì–´</b>ë¥¼ ì…ë ¥í•˜ë©´ ëˆ„ì  ì ìˆ˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    console.log('game.html loaded');
    document.addEventListener('DOMContentLoaded', function() {
      // ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ roomId, nickname ì¶”ì¶œ
      function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }
      const roomId = getQueryParam('roomId');
      const nickname = getQueryParam('nickname');
      if (!roomId || !nickname) {
        alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.');
        window.location.href = '/room-list.html';
        return;
      }
      const socket = io();
      socket.on('connect', () => {
        console.log('socket connected! id:', socket.id);
      });
      socket.emit('join', { roomId, nickname }, (res) => {
        if (!res.success && res.message !== 'ì¤‘ë³µ ë‹‰ë„¤ì„') {
          alert(res.message);
          window.location.href = '/room-list.html';
        }
      });

      // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
      let myCards = [];
      let selected = [];
      let myIdx = null;
      let turnInfo = null;
      let field = null;
      let ordered = [];
      let isCardSelectionMode = false; // ì¹´ë“œ ì„ íƒ ëª¨ë“œ í”Œë˜ê·¸
      console.log('roleAssigned:', ordered);

      let turnCountdown = null;
      let turnEndTime = null;
      let timerEnabled = true; // ì„œë²„ì—ì„œ íƒ€ì´ë¨¸ ìƒíƒœë¥¼ ë°›ìœ¼ë©´ ê°±ì‹ ë¨
      let turnTimeSeconds = 30; // ê¸°ë³¸ 30ì´ˆ

      function startTurnCountdown() {
        if (!timerEnabled || !turnEndTime) {
          if (turnCountdown) {
            clearInterval(turnCountdown);
            turnCountdown = null;
          }
          updateTurnTimerUI();
          return;
        }
        clearInterval(turnCountdown);
        updateTurnTimerUI();
        turnCountdown = setInterval(() => {
          updateTurnTimerUI();
          if (getTurnTimeLeft() <= 0) {
            clearInterval(turnCountdown);
          }
        }, 1000);
      }

      function getTurnTimeLeft() {
        if (!turnEndTime) return 0;
        const timeLeft = Math.max(0, Math.floor((turnEndTime - Date.now()) / 1000));
        return timeLeft;
      }

      function updateTurnTimerUI() {
        const timerDiv = document.getElementById('turnTimer');
        if (timerDiv && timerEnabled && turnInfo && turnInfo.currentPlayer && turnEndTime) {
          const left = getTurnTimeLeft();
          timerDiv.textContent = `â° ë‚¨ì€ ì‹œê°„: ${left}ì´ˆ (${turnTimeSeconds}ì´ˆ ì„¤ì •)`;
        } else if (timerDiv) {
          timerDiv.textContent = '';
        }
      }

      // ê²Œì„ í™”ë©´ ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
      function renderGame() {
        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;

        let html = '';

        // 1. ì›íƒ ê·¸ë¦¬ê¸°
        if (ordered && ordered.length > 0) {
          const n = ordered.length;
          // í™”ë©´ í¬ê¸°ì— ë”°ë¼ ì›íƒ í¬ê¸° ì¡°ì •
          const isMobile = window.innerWidth <= 768;
          const isSmallMobile = window.innerWidth <= 480;
          const tableSize = isSmallMobile ? 250 : isMobile ? 300 : 400;
          const radius = tableSize / 2;
          const playerCardWidth = isSmallMobile ? 70 : isMobile ? 80 : 120;
          const playerCardHeight = isSmallMobile ? 50 : isMobile ? 60 : 80;
          
          html += `<div class="table-circle" style="position:relative;width:${tableSize}px;height:${tableSize}px;margin:0 auto;background:#f5f5dc;border-radius:50%;box-shadow:0 2px 12px rgba(0,0,0,0.08);margin-bottom: 1em;">`;
          ordered.forEach((p, i) => {
            const angle = (2 * Math.PI * i) / n - Math.PI / 2;
            const x = tableSize/2 + radius * Math.cos(angle) - playerCardWidth/2;
            const y = tableSize/2 + radius * Math.sin(angle) - playerCardHeight/2;
            const isMyTurn = turnInfo && turnInfo.currentPlayer && turnInfo.currentPlayer.id === p.id;
            const amI = p.id === socket.id;
            const isFinished = p.finished;
            let borderColor = 'transparent';
            let backgroundColor = 'white';
            if (amI) borderColor = '#ff9800';
            if (isMyTurn) backgroundColor = '#adf0b1';
            if (isFinished) {
              backgroundColor = '#e0e0e0';
              borderColor = '#9e9e9e';
            }

            html += `<div class="player-card" style="position:absolute;left:${x}px;top:${y}px;width:${playerCardWidth}px;height:${playerCardHeight}px;text-align:center;background:${backgroundColor};border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,0.08);padding:0.5em 0.2em;display:flex;flex-direction:column;justify-content:center;align-items:center;border: 3px solid ${borderColor}; transition: all 0.3s;">
              <div style='font-weight:bold;font-size:1.1em;'>${p.role}</div>
              <div style='margin:0.2em 0;'>${p.nickname}</div>
              <div style='font-size:0.9em;color:#666;'>${isFinished ? 'ğŸ ì™„ì£¼!' : `ì¹´ë“œ ${p.cardCount || 0}ì¥`}</div>
            </div>`;
          });
          // í•„ë“œ(ì´ì „ì— ë‚¸ ì¹´ë“œ)ë¥¼ í…Œì´ë¸” ì¤‘ì•™ì— ë…¸ì¶œ
          html += '<div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:1.3em;font-weight:bold;text-align:center;">';
          if (field && field.number) {
            html += '<div style="margin-top:0.7em;font-size:1.1em;text-align:center;">';
            html += '<div style="margin-bottom:0.5em;font-weight:bold;">í•„ë“œ</div>';
            html += '<div style="display:flex;justify-content:center;">';
            if (field.cards && Array.isArray(field.cards)) {
              field.cards.forEach((card, i) => {
                html += `<div style="overflow:visible;width:20px;flex-grow:1;${i === field.cards.length - 1 ? 'width:80px;flex-grow:0;' : ''}">`;
                html += `<div style="width:80px;height:130px;background:#fffbe6;border:4px solid #bdb76b;box-shadow:-3px 0px 8px rgba(0,0,0,0.4);box-sizing:border-box;position:relative;border-radius:6px;">`;
                html += `<div style="position:absolute;top:3px;left:3px;font-size:1em;font-weight:bold;">${card === 'J' ? 'ğŸƒ' : card}</div>`;
                html += '</div>';
                html += '</div>';
              });
            } else {
              for (let i = 0; i < field.count; i++) {
                html += `<div style="overflow:visible;width:20px;flex-grow:1;${i === field.count - 1 ? 'width:80px;flex-grow:0;' : ''}">`;
                html += `<div style="width:80px;height:130px;background:#fffbe6;border:4px solid #bdb76b;box-shadow:-3px 0px 8px rgba(0,0,0,0.4);box-sizing:border-box;position:relative;border-radius:6px;">`;
                html += `<div style="position:absolute;top:3px;left:3px;font-size:1em;font-weight:bold;">${field.number === 'J' ? 'ğŸƒ' : field.number}</div>`;
                html += '</div>';
                html += '</div>';
              }
            }
            html += '</div>';
            html += `<div style="margin-top:0.5em;font-size:0.9em;color:#666;"><b>í•„ë“œ:</b> ìˆ«ì ${field.number} (${field.count}ì¥)</div>`;
            html += '</div>';
          }
          html += '</div>';
          html += '</div>';
        }

        // 2. í•„ë“œ (ì´ì „ì— ë‚¸ ì¹´ë“œ)
        // ê¸°ì¡´ ì¤‘ì•™ í‘œì‹œ ì½”ë“œëŠ” ì‚­ì œ ë˜ëŠ” ì£¼ì„ì²˜ë¦¬
        // if (field && field.number) {
        //   html += '<div style="text-align:center;margin:1em 0;font-size:1.1em">';
        //   html += `<b>í•„ë“œ:</b> ìˆ«ì ${field.number} (${field.count}ì¥)`;
        //   html += '</div>';
        // }

        // 3. í„´ ì •ë³´
        if (turnInfo && turnInfo.currentPlayer) {
          html += `<div style="text-align:center;margin:3.5em 0 1em 0;font-size:1.2em;">`;
          if (turnInfo.currentPlayer.id === socket.id) {
            html += '<div style="color:#4caf50;font-weight:bold;">ğŸ¯ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!</div>';
            if (turnInfo.isFirstTurnOfRound) {
              html += '<div style="color:#f57c00;font-weight:bold;margin-top:0.5em;">âš ï¸ ìƒˆë¡œìš´ ë¼ìš´ë“œì˜ ì²« í„´ì…ë‹ˆë‹¤! íŒ¨ìŠ¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
          } else {
            html += `í˜„ì¬ ì°¨ë¡€: <b>${turnInfo.currentPlayer.nickname}</b> (${turnInfo.currentPlayer.role})`;
            if (turnInfo.isFirstTurnOfRound) {
              html += '<div style="color:#f57c00;font-weight:bold;margin-top:0.5em;">âš ï¸ ìƒˆë¡œìš´ ë¼ìš´ë“œì˜ ì²« í„´ì…ë‹ˆë‹¤!</div>';
            }
          }
          html += '</div>';
          html += '<div id="turnTimer" style="text-align:center;font-size:1.1em;margin-bottom:1em;"></div>';
        }

        // 4. ë‚´ ì¹´ë“œ
        if (myCards && myCards.length > 0) {
          html += '<div style="margin-top:1em;border-top:1px solid #ccc;padding-top:1em;">';
          html += '<h2 style="text-align:center;margin:0 0 1em 0;">ë‚´ ì¹´ë“œ</h2>';
          html += '<div id="handArea" style="display:flex;background:#eee;padding:10px;box-sizing:border-box;margin:0 auto 10px auto;overflow:visible;">';
          myCards.forEach((card, i) => {
            const isSelected = selected.includes(i);
            html += `<div class="cardBtn" data-idx="${i}" style="overflow:visible;width:40px;flex-grow:1;${i === myCards.length - 1 ? 'width:100px;flex-grow:0;' : ''}">`;
            html += `<div style="width:100px;height:200px;background:${isSelected ? '#ffe082' : '#fffbe6'};border:5px solid ${isSelected ? '#ff9800' : '#bdb76b'};box-shadow:-5px 0px 10px rgba(0,0,0,0.5);box-sizing:border-box;position:relative;cursor:pointer;transition:all 0.2s;border-radius:8px;">`;
            html += `<div style="position:absolute;top:5px;left:5px;font-size:1.2em;font-weight:bold;">${card === 'J' ? 'ğŸƒ' : card}</div>`;
            html += '</div>';
            html += '</div>';
          });
          html += '</div>';
          html += '<div style="text-align:center;margin-top:1.5em;">';
          html += '<button id="submitBtn" style="padding:0.7em 2em;font-size:1.1em;margin-right:1em;">ì œì¶œ</button>';
          
          // ë§ˆì§€ë§‰ í”Œë ˆì´ì–´ê°€ ë‚¨ì•˜ëŠ”ì§€ í™•ì¸
          const activePlayers = ordered.filter(p => !p.finished).length;
          const isFirstTurn = turnInfo && turnInfo.isFirstTurnOfRound;
          const isMyTurn = turnInfo && turnInfo.currentPlayer && turnInfo.currentPlayer.id === socket.id;
          
          if (activePlayers > 1 && !(isFirstTurn && isMyTurn)) {
            html += '<button id="passBtn" style="padding:0.7em 2em;font-size:1.1em;">íŒ¨ìŠ¤</button>';
          } else if (isFirstTurn && isMyTurn) {
            html += '<button id="passBtn" style="padding:0.7em 2em;font-size:1.1em;background:#ffcdd2;color:#c62828;cursor:not-allowed;" disabled>ì²« í„´ íŒ¨ìŠ¤ ë¶ˆê°€</button>';
          } else {
            html += '<button id="passBtn" style="padding:0.7em 2em;font-size:1.1em;background:#ccc;color:#666;cursor:not-allowed;" disabled>íŒ¨ìŠ¤ ë¶ˆê°€</button>';
          }
          html += '</div>';
          html += '</div>';
        }

        gameContent.innerHTML = html;

        // 5. ì¹´ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì—°ê²°
        if (myCards && myCards.length > 0) {
           // ì¹´ë“œ ì„ íƒ
          document.querySelectorAll('.cardBtn').forEach(btn => {
            btn.onclick = function() {
              const idx = parseInt(this.getAttribute('data-idx'));
              const clickedCard = myCards[idx];

              if (selected.includes(idx)) { // ì„ íƒ í•´ì œ
                selected = selected.filter(i => i !== idx);
              } else { // ìƒˆë¡œ ì„ íƒ
                if (selected.length === 0) {
                  selected.push(idx);
                } else {
                  const firstCard = myCards[selected[0]];
                  // ì¡°ì»¤ëŠ” ì–´ë–¤ ì¹´ë“œì™€ë„ í•¨ê»˜ ì„ íƒ ê°€ëŠ¥
                  if (clickedCard === 'J' || firstCard === 'J' || clickedCard === firstCard) {
                    selected.push(idx);
                  } else {
                    alert('ê°™ì€ ìˆ«ì ë˜ëŠ” ì¡°ì»¤ë§Œ í•¨ê»˜ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                  }
                }
              }
              renderGame();
            };
          });
          // ì œì¶œ ë²„íŠ¼
          document.getElementById('submitBtn').onclick = function() {
            if (turnInfo && turnInfo.currentPlayer.id !== socket.id) {
              alert('ì•„ì§ ë‚´ ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤!');
              return;
            }
            if (selected.length === 0) {
              alert('ì œì¶œí•  ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
              return;
            }
            const cardsToPlay = selected.map(i => myCards[i]);
            socket.emit('playCards', cardsToPlay, (res) => {
              if (res && !res.success) {
                alert(res.message);
              } else {
                // ì„±ê³µ ì‹œ ì„ íƒ í•´ì œ
                selected = [];
              }
            });
          };
          // íŒ¨ìŠ¤ ë²„íŠ¼
          document.getElementById('passBtn').onclick = function() {
            if (turnInfo && turnInfo.currentPlayer.id !== socket.id) {
              alert('ì•„ì§ ë‚´ ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤!');
              return;
            }
            socket.emit('passTurn', (res) => {
              if (res && !res.success) {
                alert(res.message);
              }
            });
          };
        }

        // íƒ€ì´ë¨¸ UI ê°±ì‹ 
        updateTurnTimerUI();
      }

      // --- í„´ íƒ€ì´ë¨¸ UI ë™ê¸°í™” ---
      function syncTurnTimer() {
        if (!timerEnabled || !turnEndTime) {
          if (turnCountdown) {
            clearInterval(turnCountdown);
            turnCountdown = null;
          }
          updateTurnTimerUI();
          return;
        }
        startTurnCountdown();
      }

      socket.on('turnChanged', (data) => {
        turnInfo = data;
        renderGame();
        // turnTimerStart ì´ë²¤íŠ¸ì—ì„œ íƒ€ì´ë¨¸ê°€ ì‹œì‘ë¨
      });
      socket.on('newRound', (data) => {
        turnInfo = data;
        field = null;
        appendChat('ğŸ”„ ìƒˆë¡œìš´ ë¼ìš´ë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤!', false, true);
        // ì²« í„´ í”Œë ˆì´ì–´ì—ê²Œ íŠ¹ë³„ ë©”ì‹œì§€
        if (data.currentPlayer && data.currentPlayer.id === socket.id) {
          appendChat('ğŸ¯ ìƒˆë¡œìš´ ë¼ìš´ë“œì˜ ì²« í„´ì…ë‹ˆë‹¤! íŒ¨ìŠ¤í•  ìˆ˜ ì—†ìœ¼ë‹ˆ ì¹´ë“œë¥¼ ë‚´ì£¼ì„¸ìš”.', false, true);
        }
        renderGame();
        // turnTimerStart ì´ë²¤íŠ¸ì—ì„œ íƒ€ì´ë¨¸ê°€ ì‹œì‘ë¨
      });
      socket.on('playResult', (data) => {
        console.log('ì¹´ë“œ ì œì¶œ ê²°ê³¼:', data);
        if (data.ordered) ordered = data.ordered; // ìµœì‹  orderedë¡œ ê°±ì‹ 
        const player = ordered[data.playerIdx];
        const cards = data.cards.map(c => c === 'J' ? 'ğŸƒ' : c).join(' ');

        // í•„ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
        if (data.lastPlay) {
          field = { ...data.lastPlay };
        }

        // ê° í”Œë ˆì´ì–´ì˜ ì¹´ë“œ ìˆ˜ ì—…ë°ì´íŠ¸
        if (data.playerHands) {
          ordered.forEach((p, i) => {
            p.cardCount = data.playerHands[i];
          });
        }

        // ë‚´ê°€ ë‚¸ ì¹´ë“œë©´ ì†ì—ì„œ ì œê±°
        if (player.id === socket.id && data.myCards) {
          myCards = data.myCards.slice(); // ì„œë²„ ìƒíƒœë¡œ ë™ê¸°í™”
          selected = [];
        }
        
        // ì™„ì£¼í•œ í”Œë ˆì´ì–´ ì²´í¬
        if (data.finished[data.playerIdx]) {
          appendChat(`ğŸ ${player.nickname}ë‹˜ì´ ì™„ì£¼í–ˆìŠµë‹ˆë‹¤!`, false, true);
        }
        renderGame();
        syncTurnTimer();
      });
      socket.on('turnTimeout', () => {
        appendChat('â° ì œí•œì‹œê°„ì´ ì´ˆê³¼ë˜ì–´ ìë™ìœ¼ë¡œ íŒ¨ìŠ¤ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', false, true);
        turnEndTime = null;
        updateTurnTimerUI();
      });

      // ê²Œì„ ì´ˆê¸° ì„¤ì • ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      socket.on('gameSetup', (data) => {
        console.log('=== gameSetup ì´ë²¤íŠ¸ ìˆ˜ì‹  ===');
        console.log('gameSetup ë°ì´í„°:', data);
        console.log('í˜„ì¬ ì¹´ë“œ ì„ íƒ ëª¨ë“œ:', isCardSelectionMode);
        
        // ì¹´ë“œ ì„ íƒ ëª¨ë“œ ì¤‘ì´ë©´ gameSetupì„ ë¬´ì‹œ
        if (isCardSelectionMode) {
          console.log('ì¹´ë“œ ì„ íƒ ëª¨ë“œ ì¤‘ì´ë¯€ë¡œ gameSetupì„ ë¬´ì‹œí•©ë‹ˆë‹¤.');
          return;
        }
        
        console.log('gameSetup ì²˜ë¦¬ ì‹œì‘');
        ordered = data.ordered;
        myCards = data.myCards.sort((a,b) => (a==='J' ? 13 : a) - (b==='J' ? 13 : b));
        turnInfo = data.turnInfo;
        field = data.field;
        myIdx = ordered.findIndex(p => p.id === socket.id);
        selected = [];
        
        renderGame();
        syncTurnTimer(); // ì¹´ë“œ êµí™˜ ì™„ë£Œ í›„ ì²« í„´ì— íƒ€ì´ë¨¸ ì‹œì‘

        // 5ì´ˆ í›„ì— ìˆ«ì ì •ë³´ ì§€ìš°ê³  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        setTimeout(() => {
            if(ordered && ordered.length > 0) {
              ordered.forEach(p => delete p.card);
              renderGame();
            }
        }, 5000);
      });

      // ì¹´ë“œ êµí™˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      socket.on('cardExchange', (data) => {
        console.log('ì¹´ë“œ êµí™˜ ì™„ë£Œ:', data);
        appendChat(`ğŸ”„ ì¹´ë“œ êµí™˜ ì™„ë£Œ`, false, true);
      });

      // ë‹¬ë¬´í‹° ì¹´ë“œ ì„ íƒ ìš”ì²­ ì´ë²¤íŠ¸
      socket.on('selectCardsForSlave', (data) => {
        console.log('=== selectCardsForSlave ì´ë²¤íŠ¸ ìˆ˜ì‹  ===');
        console.log('ì´ë²¤íŠ¸ ë°ì´í„°:', data);
        console.log('í˜„ì¬ ì†Œì¼“ ID:', socket.id);
        console.log('í˜„ì¬ ë‹‰ë„¤ì„:', nickname);
        console.log('ì¹´ë“œ ì„ íƒ ëª¨ë“œ í™œì„±í™”');
        
        isCardSelectionMode = true;
        myCards = data.hand.sort((a,b) => (a==='J' ? 13 : a) - (b==='J' ? 13 : b));
        selected = [];
        
        console.log('ì •ë ¬ëœ ì¹´ë“œ:', myCards);
        
        // ì¹´ë“œ ì„ íƒ UI í‘œì‹œ
        const gameContent = document.getElementById('gameContent');
        if (gameContent) {
          console.log('gameContent ìš”ì†Œ ì°¾ìŒ, UI ìƒì„± ì‹œì‘');
          
          let html = '<div style="text-align:center;margin-bottom:2em;">';
          html += '<h2 style="color:#ff9800;">ğŸ¯ ë†ë…¸ì—ê²Œ ì¤„ ì¹´ë“œ 2ì¥ì„ ì„ íƒí•˜ì„¸ìš”</h2>';
          html += '<p style="color:#666;margin-bottom:1em;">ì •í™•íˆ 2ì¥ì˜ ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
          html += '</div>';
          
          html += '<div style="margin-top:1em;border-top:1px solid #ccc;padding-top:1em;">';
          html += '<h2 style="text-align:center;margin:0 0 1em 0;">ë‚´ ì¹´ë“œ</h2>';
          html += '<div id="handArea" style="display:flex;background:#eee;padding:10px;box-sizing:border-box;margin:0 auto 10px auto;overflow:visible;">';
          myCards.forEach((card, i) => {
            const isSelected = selected.includes(i);
            html += `<div class="cardBtn" data-idx="${i}" style="overflow:visible;width:40px;flex-grow:1;${i === myCards.length - 1 ? 'width:100px;flex-grow:0;' : ''}">`;
            html += `<div style="width:100px;height:200px;background:${isSelected ? '#ffe082' : '#fffbe6'};border:5px solid ${isSelected ? '#ff9800' : '#bdb76b'};box-shadow:-5px 0px 10px rgba(0,0,0,0.5);box-sizing:border-box;position:relative;cursor:pointer;transition:all 0.2s;border-radius:8px;">`;
            html += `<div style="position:absolute;top:5px;left:5px;font-size:1.2em;font-weight:bold;">${card === 'J' ? 'ğŸƒ' : card}</div>`;
            html += '</div>';
            html += '</div>';
          });
          html += '</div>';
          html += '<div style="text-align:center;margin-top:1.5em;">';
          html += '<button id="confirmSelectionBtn" style="padding:0.7em 2em;font-size:1.1em;background:#4caf50;color:white;border:none;border-radius:8px;cursor:pointer;">ì„ íƒ ì™„ë£Œ</button>';
          html += '</div>';
          html += '</div>';
          
          gameContent.innerHTML = html;
          console.log('ì¹´ë“œ ì„ íƒ UI ìƒì„± ì™„ë£Œ');
          
          // ì¹´ë“œ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          document.querySelectorAll('.cardBtn').forEach(btn => {
            btn.onclick = function() {
              const idx = parseInt(this.getAttribute('data-idx'));
              
              if (selected.includes(idx)) { // ì„ íƒ í•´ì œ
                selected = selected.filter(i => i !== idx);
              } else { // ìƒˆë¡œ ì„ íƒ
                if (selected.length < 2) {
                  selected.push(idx);
                } else {
                  alert('ìµœëŒ€ 2ì¥ê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
              }
              
              // UI ì—…ë°ì´íŠ¸
              document.querySelectorAll('.cardBtn').forEach((cardBtn, i) => {
                const cardDiv = cardBtn.querySelector('div');
                const isSelected = selected.includes(i);
                cardDiv.style.background = isSelected ? '#ffe082' : '#fffbe6';
                cardDiv.style.borderColor = isSelected ? '#ff9800' : '#bdb76b';
              });
            };
          });
          
          // ì„ íƒ ì™„ë£Œ ë²„íŠ¼
          document.getElementById('confirmSelectionBtn').onclick = function() {
            if (selected.length !== 2) {
              alert('ì •í™•íˆ 2ì¥ì˜ ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
              return;
            }
            
            const selectedCards = selected.map(i => myCards[i]);
            console.log('ì„ íƒëœ ì¹´ë“œ:', selectedCards);
            socket.emit('dalmutiCardSelection', selectedCards, (res) => {
              if (res && !res.success) {
                alert(res.message);
              } else {
                isCardSelectionMode = false;
                appendChat('âœ… ì¹´ë“œ ì„ íƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', false, true);
              }
            });
          };
        } else {
          console.error('gameContent ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
      });

      // ëŒ€ì£¼êµ ì¹´ë“œ ì„ íƒ ìš”ì²­ ì´ë²¤íŠ¸
      socket.on('selectCardsForMiner', (data) => {
        console.log('=== selectCardsForMiner ì´ë²¤íŠ¸ ìˆ˜ì‹  ===');
        console.log('ì´ë²¤íŠ¸ ë°ì´í„°:', data);
        console.log('í˜„ì¬ ì†Œì¼“ ID:', socket.id);
        console.log('í˜„ì¬ ë‹‰ë„¤ì„:', nickname);
        console.log('ì¹´ë“œ ì„ íƒ ëª¨ë“œ í™œì„±í™”');
        
        isCardSelectionMode = true;
        myCards = data.hand.sort((a,b) => (a==='J' ? 13 : a) - (b==='J' ? 13 : b));
        selected = [];
        
        console.log('ì •ë ¬ëœ ì¹´ë“œ:', myCards);
        
        // ì¹´ë“œ ì„ íƒ UI í‘œì‹œ
        const gameContent = document.getElementById('gameContent');
        if (gameContent) {
          console.log('gameContent ìš”ì†Œ ì°¾ìŒ, UI ìƒì„± ì‹œì‘');
          
          let html = '<div style="text-align:center;margin-bottom:2em;">';
          html += '<h2 style="color:#ff9800;">ğŸ¯ ê´‘ë¶€ì—ê²Œ ì¤„ ì¹´ë“œ 1ì¥ì„ ì„ íƒí•˜ì„¸ìš”</h2>';
          html += '<p style="color:#666;margin-bottom:1em;">ì •í™•íˆ 1ì¥ì˜ ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>';
          html += '</div>';
          
          html += '<div style="margin-top:1em;border-top:1px solid #ccc;padding-top:1em;">';
          html += '<h2 style="text-align:center;margin:0 0 1em 0;">ë‚´ ì¹´ë“œ</h2>';
          html += '<div id="handArea" style="display:flex;background:#eee;padding:10px;box-sizing:border-box;margin:0 auto 10px auto;overflow:visible;">';
          myCards.forEach((card, i) => {
            const isSelected = selected.includes(i);
            html += `<div class="cardBtn" data-idx="${i}" style="overflow:visible;width:40px;flex-grow:1;${i === myCards.length - 1 ? 'width:100px;flex-grow:0;' : ''}">`;
            html += `<div style="width:100px;height:200px;background:${isSelected ? '#ffe082' : '#fffbe6'};border:5px solid ${isSelected ? '#ff9800' : '#bdb76b'};box-shadow:-5px 0px 10px rgba(0,0,0,0.5);box-sizing:border-box;position:relative;cursor:pointer;transition:all 0.2s;border-radius:8px;">`;
            html += `<div style="position:absolute;top:5px;left:5px;font-size:1.2em;font-weight:bold;">${card === 'J' ? 'ğŸƒ' : card}</div>`;
            html += '</div>';
            html += '</div>';
          });
          html += '</div>';
          html += '<div style="text-align:center;margin-top:1.5em;">';
          html += '<button id="confirmSelectionBtn" style="padding:0.7em 2em;font-size:1.1em;background:#4caf50;color:white;border:none;border-radius:8px;cursor:pointer;">ì„ íƒ ì™„ë£Œ</button>';
          html += '</div>';
          html += '</div>';
          
          gameContent.innerHTML = html;
          console.log('ì¹´ë“œ ì„ íƒ UI ìƒì„± ì™„ë£Œ');
          
          // ì¹´ë“œ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          document.querySelectorAll('.cardBtn').forEach(btn => {
            btn.onclick = function() {
              const idx = parseInt(this.getAttribute('data-idx'));
              
              if (selected.includes(idx)) { // ì„ íƒ í•´ì œ
                selected = selected.filter(i => i !== idx);
              } else { // ìƒˆë¡œ ì„ íƒ
                if (selected.length < 1) {
                  selected.push(idx);
                } else {
                  alert('ìµœëŒ€ 1ì¥ê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
              }
              
              // UI ì—…ë°ì´íŠ¸
              document.querySelectorAll('.cardBtn').forEach((cardBtn, i) => {
                const cardDiv = cardBtn.querySelector('div');
                const isSelected = selected.includes(i);
                cardDiv.style.background = isSelected ? '#ffe082' : '#fffbe6';
                cardDiv.style.borderColor = isSelected ? '#ff9800' : '#bdb76b';
              });
            };
          });
          
          // ì„ íƒ ì™„ë£Œ ë²„íŠ¼
          document.getElementById('confirmSelectionBtn').onclick = function() {
            if (selected.length !== 1) {
              alert('ì •í™•íˆ 1ì¥ì˜ ì¹´ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
              return;
            }
            
            const selectedCards = selected.map(i => myCards[i]);
            console.log('ì„ íƒëœ ì¹´ë“œ:', selectedCards);
            socket.emit('archbishopCardSelection', selectedCards, (res) => {
              if (res && !res.success) {
                alert(res.message);
              } else {
                isCardSelectionMode = false;
                appendChat('âœ… ì¹´ë“œ ì„ íƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', false, true);
              }
            });
          };
        } else {
          console.error('gameContent ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
      });

      // ë‹¬ë¬´í‹° ì¹´ë“œ ì„ íƒ ëŒ€ê¸° ì´ë²¤íŠ¸
      socket.on('waitingForDalmuti', (data) => {
        console.log('=== waitingForDalmuti ì´ë²¤íŠ¸ ìˆ˜ì‹  ===');
        console.log('ëŒ€ê¸° ë©”ì‹œì§€:', data);
        console.log('í˜„ì¬ ì†Œì¼“ ID:', socket.id);
        console.log('í˜„ì¬ ë‹‰ë„¤ì„:', nickname);
        
        appendChat(`â³ ${data.message}`, false, true);
        
        // ëŒ€ê¸° í™”ë©´ í‘œì‹œ
        const gameContent = document.getElementById('gameContent');
        if (gameContent) {
          console.log('ëŒ€ê¸° í™”ë©´ UI ìƒì„± ì‹œì‘');
          let html = '<div style="text-align:center;margin:2em 0;">';
          html += '<h2 style="color:#666;">â³ ì¹´ë“œ êµí™˜ ëŒ€ê¸° ì¤‘...</h2>';
          html += `<p style="color:#888;">${data.message}</p>`;
          html += '<div style="margin-top:2em;font-size:2em;">ğŸ”„</div>';
          html += '</div>';
          gameContent.innerHTML = html;
          console.log('ëŒ€ê¸° í™”ë©´ UI ìƒì„± ì™„ë£Œ');
        } else {
          console.error('gameContent ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
      });

      // ì¹´ë“œ êµí™˜ ëŒ€ê¸° ì´ë²¤íŠ¸ (ë‹¬ë¬´í‹°ì™€ ëŒ€ì£¼êµ ëª¨ë‘)
      socket.on('waitingForCardExchange', (data) => {
        console.log('=== waitingForCardExchange ì´ë²¤íŠ¸ ìˆ˜ì‹  ===');
        console.log('ëŒ€ê¸° ë©”ì‹œì§€:', data);
        console.log('í˜„ì¬ ì†Œì¼“ ID:', socket.id);
        console.log('í˜„ì¬ ë‹‰ë„¤ì„:', nickname);
        
        appendChat(`â³ ${data.message}`, false, true);
        
        // ëŒ€ê¸° í™”ë©´ í‘œì‹œ
        const gameContent = document.getElementById('gameContent');
        if (gameContent) {
          console.log('ëŒ€ê¸° í™”ë©´ UI ìƒì„± ì‹œì‘');
          let html = '<div style="text-align:center;margin:2em 0;">';
          html += '<h2 style="color:#666;">â³ ì¹´ë“œ êµí™˜ ëŒ€ê¸° ì¤‘...</h2>';
          html += `<p style="color:#888;">${data.message}</p>`;
          html += '<div style="margin-top:2em;font-size:2em;">ğŸ”„</div>';
          html += '</div>';
          gameContent.innerHTML = html;
          console.log('ëŒ€ê¸° í™”ë©´ UI ìƒì„± ì™„ë£Œ');
        } else {
          console.error('gameContent ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
      });

      // ì‹ ë¶„ ë° ìë¦¬ ë°°ì • ê²°ê³¼ (ë‹¤ìŒ ë¼ìš´ë“œìš©)
      socket.on('roleAssigned', (newOrdered) => {
        console.log('roleAssigned for next round:', newOrdered);
        ordered = newOrdered;
        myIdx = ordered.findIndex(p => p.id === socket.id);
        // ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ìœ„í•´ ë‹¤ë¥¸ ìƒíƒœ ì´ˆê¸°í™”
        myCards = [];
        selected = [];
        turnInfo = null;
        field = null;
        renderGame();
      });

      // ë‚´ ì¹´ë“œ í‘œì‹œ (ë‹¤ìŒ ë¼ìš´ë“œìš©)
      socket.on('dealCards', (cards) => {
        myCards = cards.sort((a,b) => (a==='J' ? 13 : a) - (b==='J' ? 13 : b));
        selected = [];
        renderGame();
      });

      // ê²Œì„ ì‹œì‘ ì•Œë¦¼ (ë‹¤ìŒ ë¼ìš´ë“œìš©)
      socket.on('gameStarted', (data) => {
        console.log('Game started for next round:', data);
        turnInfo = data;
        renderGame();
      });

      // ì°¨ë¡€ ë³€ê²½ ì•Œë¦¼
      socket.on('turnChanged', (data) => {
        console.log('ì°¨ë¡€ ë³€ê²½:', data);
        turnInfo = data;
        renderGame();
        syncTurnTimer();
      });

      // ì¹´ë“œ ì œì¶œ ê²°ê³¼
      socket.on('playResult', (data) => {
        console.log('ì¹´ë“œ ì œì¶œ ê²°ê³¼:', data);
        const player = ordered[data.playerIdx];
        const cards = data.cards.map(c => c === 'J' ? 'ğŸƒ' : c).join(' ');

        // í•„ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
        if (data.lastPlay) {
          field = { ...data.lastPlay };
        }

        // ê° í”Œë ˆì´ì–´ì˜ ì¹´ë“œ ìˆ˜ ì—…ë°ì´íŠ¸
        if (data.playerHands) {
          ordered.forEach((p, i) => {
            p.cardCount = data.playerHands[i];
          });
        }

        // ë‚´ê°€ ë‚¸ ì¹´ë“œë©´ ì†ì—ì„œ ì œê±°
        if (player.id === socket.id && data.myCards) {
          myCards = data.myCards.slice(); // ì„œë²„ ìƒíƒœë¡œ ë™ê¸°í™”
          selected = [];
        }
        
        // ì™„ì£¼í•œ í”Œë ˆì´ì–´ ì²´í¬
        if (data.finished[data.playerIdx]) {
          appendChat(`ğŸ ${player.nickname}ë‹˜ì´ ì™„ì£¼í–ˆìŠµë‹ˆë‹¤!`, false, true);
        }
        renderGame();
        syncTurnTimer();
      });

      // íŒ¨ìŠ¤ ê²°ê³¼
      socket.on('passResult', (data) => {
        console.log('íŒ¨ìŠ¤ ê²°ê³¼:', data);
        const player = ordered[data.playerIdx];
        appendChat(`â­ï¸ ${player.nickname}ë‹˜ì´ íŒ¨ìŠ¤í–ˆìŠµë‹ˆë‹¤. (${data.passes}ë²ˆì§¸ íŒ¨ìŠ¤)`, false, true);
      });

      // ìƒˆë¡œìš´ ë¼ìš´ë“œ ì‹œì‘
      socket.on('newRound', (data) => {
        console.log('ìƒˆ ë¼ìš´ë“œ:', data);
        turnInfo = data;
        field = null; // í•„ë“œ ì´ˆê¸°í™”
        appendChat('ğŸ”„ ìƒˆë¡œìš´ ë¼ìš´ë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤!', false, true);
        renderGame();
        syncTurnTimer();
      });

      // ê²Œì„ ì¤‘ë‹¨
      socket.on('gameInterrupted', (data) => {
        console.log('ê²Œì„ ì¤‘ë‹¨:', data);

        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;

        let html = '<h1 style="text-align:center;color:#f44336;">âš ï¸ ê²Œì„ ì¤‘ë‹¨</h1>';
        html += '<div style="text-align:center;margin-bottom:2em;">';
        html += '<h2>ê²Œì„ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤</h2>';
        html += `<p style="color:#666;font-size:1.1em;">${data.message}</p>`;
        html += '<p style="color:#888;">í”Œë ˆì´ì–´ê°€ ë¶€ì¡±í•˜ì—¬ ê²Œì„ì„ ê³„ì†í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        html += '<p style="color:#f57c00;font-weight:bold;margin-top:1em;">ğŸ’¡ ìƒë‹¨ì˜ "ê²Œì„ ë‚˜ê°€ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¡œë¹„ë¡œ ëŒì•„ê°€ì£¼ì„¸ìš”.</p>';
        html += '</div>';
        gameContent.innerHTML = html;

        appendChat('âš ï¸ ê²Œì„ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒë‹¨ì˜ ê²Œì„ ë‚˜ê°€ê¸° ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¡œë¹„ë¡œ ëŒì•„ê°€ì£¼ì„¸ìš”.', false, true);
      });

      // ê²Œì„ ì¢…ë£Œ ë° ì ìˆ˜
      socket.on('gameEnd', (result) => {
        console.log('ê²Œì„ ì¢…ë£Œ:', result);

        // ê²Œì„ ìƒíƒœ ë³€ìˆ˜ë“¤ ì´ˆê¸°í™”
        myCards = [];
        selected = [];
        myIdx = null;
        turnInfo = null;
        field = null;
        ordered = [];
        isCardSelectionMode = false;

        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;

        let html = '<h1 style="text-align:center;">ê²Œì„ ì¢…ë£Œ!</h1>';
        html += '<div style="text-align:center;margin-bottom:2em;">';
        html += '<h2>ğŸ† ì™„ì£¼ ìˆœì„œ</h2>';
        result.forEach((player, i) => {
          const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ…';
          html += `<div style="margin:0.5em 0;font-size:1.1em;">`;
          html += `${medal} ${i + 1}ìœ„: ${player.nickname} (${player.role}) - ${player.score}ì  (ì´ì : ${player.total}ì )`;
          html += '</div>';
        });
        html += '</div>';
        html += '<p style="text-align:center;">ì ì‹œ í›„ ë‹¤ìŒ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...</p>';
        gameContent.innerHTML = html;

        appendChat('ğŸ‰ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', false, true);
      });

      // ìµœì¢… ê²°ê³¼ (5íŒ ì™„ë£Œ)
      socket.on('finalResult', (result) => {
        console.log('ìµœì¢… ê²°ê³¼:', result);

        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;

        let html = '<h1 style="text-align:center;">ğŸŠ ìµœì¢… ê²°ê³¼ ğŸŠ</h1>';
        html += '<div style="text-align:center;margin-bottom:2em;">';
        html += '<h2>ğŸ† ìµœì¢… ìš°ìŠ¹ì</h2>';
        result.forEach((player, i) => {
          const medal = i === 0 ? 'ğŸ‘‘' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ…';
          html += `<div style="margin:0.5em 0;font-size:1.1em;">`;
          html += `${medal} ${i + 1}ìœ„: ${player.nickname} - ${player.score}ì `;
          html += '</div>';
        });
        html += '</div>';
        html += '<div style="text-align:center;">';
        html += '<button onclick="window.location.href=\'/lobby.html\'" style="padding:1em 2em;font-size:1.2em;background:#4caf50;color:white;border:none;border-radius:8px;cursor:pointer;">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>';
        html += '</div>';

        gameContent.innerHTML = html;

        appendChat('ğŸŠ 5íŒ ì™„ë£Œ! ìµœì¢… ê²°ê³¼ì…ë‹ˆë‹¤!', false, true);
      });

      // ì±„íŒ… ê¸°ëŠ¥
      const chatMessages = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');
      function appendChat(msg, isMine, isSystem) {
        const div = document.createElement('div');
        div.className = 'chat-bubble' + (isSystem ? ' system' : isMine ? ' mine' : ' user');
        div.textContent = msg;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      chatSend.onclick = sendChat;
      chatInput.onkeydown = function(e) { if (e.key === 'Enter') sendChat(); };
      
      function sendChat() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        socket.emit('chat', msg); // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ë§Œ í•¨
        chatInput.value = '';
      }

      socket.on('chat', (data) => {
        // ì„œë²„ë¡œë¶€í„° ë°›ì€ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
        if (typeof data === 'object' && data.nickname && data.msg) {
            const isMine = data.nickname === nickname;
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì•„ë‹˜
            appendChat(`${isMine ? 'ë‚˜' : data.nickname}: ${data.msg}`, isMine, false);
        }
      });

      // --- ê²Œì„ ë‚˜ê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ---
      const leaveBtn = document.getElementById('leaveGameBtn');
      if (leaveBtn) {
        leaveBtn.addEventListener('click', function() {
          if (confirm('ì •ë§ ê²Œì„ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            console.log('ê²Œì„ ë‚˜ê°€ê¸° ë²„íŠ¼ í´ë¦­ë¨');
            socket.emit('leaveGame');
            // ë²„íŠ¼ ë¹„í™œì„±í™”í•˜ì—¬ ì¤‘ë³µ í´ë¦­ ë°©ì§€
            leaveBtn.disabled = true;
            leaveBtn.textContent = 'ë‚˜ê°€ëŠ” ì¤‘...';
            leaveBtn.style.background = '#ccc';
          }
        });
      }
      // --- resetClient ì´ë²¤íŠ¸ ì²˜ë¦¬ ---
      socket.on('resetClient', () => {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = '/index.html';
      });

      socket.on('timerStatus', (data) => {
        console.log('[timerStatus] ì´ë²¤íŠ¸ ìˆ˜ì‹ :', data, '-> timerEnabled:', data.enabled);
        timerEnabled = data.enabled;
        updateTurnTimerUI();
      });

      socket.on('timerTimeChanged', (data) => {
        console.log('[timerTimeChanged] ì´ë²¤íŠ¸ ìˆ˜ì‹ :', data);
        turnTimeSeconds = data.time;
        // íƒ€ì´ë¨¸ ì‹œê°„ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ UI ì—…ë°ì´íŠ¸
        updateTurnTimerUI();
      });

      // ë„ì›€ë§ ë²„íŠ¼/ëª¨ë‹¬
      document.getElementById('helpBtn').onclick = function() {
        document.getElementById('helpModal').style.display = 'flex';
        // ì±„íŒ…ì°½ ìˆ¨ê¸°ê¸°
        document.getElementById('chatWrap').style.display = 'none';
        // body ìŠ¤í¬ë¡¤ ë§‰ê¸°
        document.body.style.overflow = 'hidden';
      };
      document.getElementById('closeHelp').onclick = function() {
        document.getElementById('helpModal').style.display = 'none';
        // ì±„íŒ…ì°½ ë‹¤ì‹œ ë³´ì´ê¸°
        document.getElementById('chatWrap').style.display = '';
        // body ìŠ¤í¬ë¡¤ ë‹¤ì‹œ í—ˆìš©
        document.body.style.overflow = '';
      };

      socket.on('turnTimerStart', (data) => {
        // ì„œë²„ì—ì„œ ì „ì†¡ëœ ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ì‚¬ìš©
        if (data.startTime && data.endTime) {
          const serverStartTime = data.startTime;
          const now = Date.now();
          
          // ë„¤íŠ¸ì›Œí¬ ì§€ì—°ì„ ë³´ì •í•˜ì—¬ ì •í™•í•œ ì¢…ë£Œ ì‹œê°„ ê³„ì‚°
          const networkDelay = now - serverStartTime;
          const correctedEndTime = data.endTime + networkDelay;
          
          turnEndTime = correctedEndTime;
          turnTimeSeconds = data.turnTime || 30;
          
          console.log(`íƒ€ì´ë¨¸ ë™ê¸°í™”: ì„œë²„ì‹œì‘=${serverStartTime}, í˜„ì¬=${now}, ì§€ì—°=${networkDelay}ms, ë³´ì •ëœì¢…ë£Œì‹œê°„=${correctedEndTime}`);
        } else {
          // fallback
          turnEndTime = data.endTime;
          turnTimeSeconds = data.turnTime || 30;
        }
        startTurnCountdown();
      });

      // í˜ëª… ì„ íƒ ìš”ì²­ ì´ë²¤íŠ¸
      socket.on('revolutionChoice', (data) => {
        console.log('=== revolutionChoice ì´ë²¤íŠ¸ ìˆ˜ì‹  ===', data);
        isCardSelectionMode = true;
        // í˜ëª… ì„ íƒ ëª¨ë‹¬ ìƒì„±
        const gameContent = document.getElementById('gameContent');
        if (gameContent) {
          let html = '<div style="text-align:center;margin:2em 0;">';
          if (data && data.role && data.nickname) {
            html += `<div style=\"font-size:1.1em;color:#333;margin-bottom:1em;\">ë‹¹ì‹ ì€ <b>${data.role}</b> (${data.nickname}) ì…ë‹ˆë‹¤.</div>`;
          }
          html += '<h2 style="color:#d32f2f;">ğŸƒğŸƒ í˜ëª… ê¸°íšŒ!</h2>';
          html += '<p style="color:#444;font-size:1.1em;margin-bottom:2em;">ì¡°ì»¤ 2ì¥ì„ ë³´ìœ í•˜ì…¨ìŠµë‹ˆë‹¤.<br>í˜ëª…ì„ ì„ ì–¸í•˜ë©´ ì¹´ë“œ êµí™˜ ì—†ì´ ë°”ë¡œ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.<br>í˜ëª…ì„ ì„ ì–¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>';
          html += '<button id="revolutionYesBtn" style="padding:0.8em 2em;font-size:1.1em;background:#d32f2f;color:white;border:none;border-radius:8px;cursor:pointer;margin-right:1em;">í˜ëª… ì„ ì–¸</button>';
          html += '<button id="revolutionNoBtn" style="padding:0.8em 2em;font-size:1.1em;background:#888;color:white;border:none;border-radius:8px;cursor:pointer;">í˜ëª… ì•ˆí•¨</button>';
          html += '</div>';
          gameContent.innerHTML = html;
          document.getElementById('revolutionYesBtn').onclick = function() {
            socket.emit('revolutionResult', { revolution: true });
            isCardSelectionMode = false;
            gameContent.innerHTML = '<div style="text-align:center;margin:2em 0;"><h2 style="color:#d32f2f;">í˜ëª… ì„ ì–¸!</h2><p style="color:#444;">ì¹´ë“œ êµí™˜ ì—†ì´ ê²Œì„ì´ ê³§ ì‹œì‘ë©ë‹ˆë‹¤...</p></div>';
          };
          document.getElementById('revolutionNoBtn').onclick = function() {
            socket.emit('revolutionResult', { revolution: false });
            isCardSelectionMode = false;
            gameContent.innerHTML = '<div style="text-align:center;margin:2em 0;"><h2 style="color:#888;">í˜ëª… ì•ˆí•¨</h2><p style="color:#444;">ì¹´ë“œ êµí™˜ ë‹¨ê³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤...</p></div>';
          };
        }
      });



      // ê²Œì„ ì‹œì‘ ì•Œë¦¼ (ëª¨ë“  ë¼ìš´ë“œ)
      socket.on('gameStart', (data) => {
        // ë§Œì•½ í˜„ì¬ í˜ì´ì§€ê°€ game.htmlì´ ì•„ë‹ˆë©´ ì´ë™
        if (!window.location.pathname.endsWith('game.html')) {
          // roomId, nickname ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ìœ ì§€
          const params = new URLSearchParams(window.location.search);
          window.location.href = '/game.html?' + params.toString();
        } else {
          // í˜ëª… ì„ íƒì´ë‚˜ ì¹´ë“œ êµí™˜ì´ í•„ìš”í•œ ê²½ìš° ê²Œì„ í™”ë©´ì„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ
          if (data && (data.needRevolutionChoice || data.needCardExchange)) {
            console.log('í˜ëª… ì„ íƒ ë˜ëŠ” ì¹´ë“œ êµí™˜ì´ í•„ìš”í•˜ë¯€ë¡œ ê²Œì„ í™”ë©´ ë Œë”ë§ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
            return;
          }
          // ì´ë¯¸ game.htmlì´ë©´ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” render
          renderGame();
        }
      });
    });
  </script>
</body>
</html> 