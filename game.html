<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‹¬ë¬´í‹° ê²Œì„</title>
  <style>
    body { display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f5dc; }
    #mainWrap { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; }
    #gameArea { min-width: 420px; }
    #chatWrap { width: 260px; margin-left: 2em; background: #fff; border-radius: 10px; box-shadow: 0 1px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; height: 540px; }
    #chatMessages { flex: 1; overflow-y: auto; padding: 1em; font-size: 1em; }
    #chatInputWrap { display: flex; border-top: 1px solid #eee; }
    #chatInput { flex: 1 1 auto; min-width: 0; border: none; padding: 0.7em; font-size: 1em; border-radius: 0 0 0 10px; }
    #chatSend { width: 56px; border: none; background: #8bc34a; color: #fff; font-size: 1em; border-radius: 0 0 10px 0; cursor: pointer; }
    #chatSend:hover { background: #689f38; }
  </style>
</head>
<body>
  <div id="mainWrap">
    <div id="gameArea">
      <h1 style="text-align:center;">ë‹¬ë¬´í‹° ê²Œì„</h1>
      <div id="gameContent"></div>
    </div>
    <div id="chatWrap">
      <div id="chatMessages"></div>
      <div id="chatInputWrap">
        <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off" />
        <button id="chatSend">ì „ì†¡</button>
      </div>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    console.log('game.html loaded');
    document.addEventListener('DOMContentLoaded', function() {
      const nickname = localStorage.getItem('dalmuti_nickname');
      if (!nickname) window.location.href = '/index.html';

      const socket = io("https://simple-dalmuti.onrender.com");
      socket.on('connect', () => {
        console.log('socket connected! id:', socket.id);
      });
      socket.on('roleAssigned', (ordered) => {
        console.log('roleAssigned:', ordered, 'ë‚´ ì†Œì¼“ id:', socket.id);
      });

      // â˜… ì„œë²„ì— ë‹‰ë„¤ì„ì„ ì•Œë¦¼
      socket.emit('join', nickname, (res) => {
        if (!res.success && res.message !== 'ì¤‘ë³µ ë‹‰ë„¤ì„') {
          alert(res.message);
          window.location.href = '/index.html';
        }
      });

      // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
      let myCards = [];
      let selected = [];
      let myIdx = null;
      let turnInfo = null;
      let field = null;
      let ordered = [];
      console.log('roleAssigned:', ordered);

      // ê²Œì„ í™”ë©´ ì „ì²´ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
      function renderGame() {
        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;

        let html = '';

        // 1. ì›íƒ ê·¸ë¦¬ê¸°
        if (ordered && ordered.length > 0) {
          const n = ordered.length;
          const radius = 160;
          html += '<div style="position:relative;width:400px;height:400px;margin:0 auto;background:#f5f5dc;border-radius:50%;box-shadow:0 2px 12px rgba(0,0,0,0.08);margin-bottom: 2em;">';
          ordered.forEach((p, i) => {
            const angle = (2 * Math.PI * i) / n - Math.PI / 2;
            const x = 200 + radius * Math.cos(angle) - 60;
            const y = 200 + radius * Math.sin(angle) - 40;
            const isMyTurn = turnInfo && turnInfo.currentPlayer && turnInfo.currentPlayer.id === p.id;
            const amI = p.id === socket.id;
            let borderColor = 'transparent';
            if (amI) borderColor = '#ff9800';
            else if (isMyTurn) borderColor = '#4caf50';

            html += `<div style="position:absolute;left:${x}px;top:${y}px;width:120px;height:80px;text-align:center;background:white;border-radius:12px;box-shadow:0 1px 6px rgba(0,0,0,0.08);padding:0.5em 0.2em;display:flex;flex-direction:column;justify-content:center;align-items:center;border: 3px solid ${borderColor}; transition: border-color 0.3s;">
              <div style='font-weight:bold;font-size:1.1em;'>${p.role}</div>
              <div style='margin:0.2em 0;'>${p.nickname}</div>
              <div style='font-size:0.9em;color:#666;'>ì¹´ë“œ ${p.cardCount || 0}ì¥</div>
              ${p.card ? `<div style='font-size:0.9em;color:#888;'>ìˆ«ì: ${p.card}</div>` : ''}
            </div>`;
          });
          // í•„ë“œ(ì´ì „ì— ë‚¸ ì¹´ë“œ)ë¥¼ í…Œì´ë¸” ì¤‘ì•™ì— ë…¸ì¶œ
          html += '<div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:1.3em;font-weight:bold;text-align:center;">';
          if (field && field.number) {
            html += `<div style=\"margin-top:0.7em;font-size:1.1em;background:#fffbe6;padding:0.5em 1.2em;border-radius:8px;border:1.5px solid #bdb76b;box-shadow:0 1px 4px rgba(0,0,0,0.08);display:inline-block;\">`;
            html += `<b>í•„ë“œ:</b> ìˆ«ì ${field.number} (${field.count}ì¥)`;
            html += '</div>';
          }
          html += '</div>';
          html += '</div>';
        }

        // 2. í•„ë“œ (ì´ì „ì— ë‚¸ ì¹´ë“œ)
        // ê¸°ì¡´ ì¤‘ì•™ í‘œì‹œ ì½”ë“œëŠ” ì‚­ì œ ë˜ëŠ” ì£¼ì„ì²˜ë¦¬
        // if (field && field.number) {
        //   html += '<div style="text-align:center;margin:1em 0;font-size:1.1em">';
        //   html += `<b>í•„ë“œ:</b> ìˆ«ì ${field.number} (${field.count}ì¥)`;
        //   html += '</div>';
        // }

        // 3. í„´ ì •ë³´
        if (turnInfo && turnInfo.currentPlayer) {
          html += `<div style="text-align:center;margin-bottom:1em;font-size:1.2em;">`;
          if (turnInfo.currentPlayer.id === socket.id) {
            html += '<div style="color:#4caf50;font-weight:bold;">ğŸ¯ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!</div>';
          } else {
            html += `í˜„ì¬ ì°¨ë¡€: <b>${turnInfo.currentPlayer.nickname}</b> (${turnInfo.currentPlayer.role})`;
          }
          html += '</div>';
        }

        // 4. ë‚´ ì¹´ë“œ
        if (myCards && myCards.length > 0) {
          html += '<div style="margin-top:1em;border-top:1px solid #ccc;padding-top:1em;">';
          html += '<h2 style="text-align:center;margin:0 0 1em 0;">ë‚´ ì¹´ë“œ</h2>';
          html += '<div id="handArea" style="display:flex;max-width:1000px;background:#eee;padding:10px;box-sizing:border-box;margin:0 auto 10px auto;overflow:visible;">';
          myCards.forEach((card, i) => {
            const isSelected = selected.includes(i);
            html += `<div class="cardBtn" data-idx="${i}" style="overflow:visible;width:20px;flex-grow:1;${i === myCards.length - 1 ? 'width:100px;flex-grow:0;' : ''}">`;
            html += `<div style="width:100px;height:200px;background:${isSelected ? '#ffe082' : '#fffbe6'};border:5px solid ${isSelected ? '#ff9800' : '#bdb76b'};box-shadow:-5px 0px 10px rgba(0,0,0,0.5);box-sizing:border-box;position:relative;cursor:pointer;transition:all 0.2s;border-radius:8px;">`;
            html += `<div style="position:absolute;top:5px;left:5px;font-size:1.2em;font-weight:bold;">${card === 'J' ? 'ğŸƒ' : card}</div>`;
            html += '</div>';
            html += '</div>';
          });
          html += '</div>';
          html += '<div style="text-align:center;margin-top:1.5em;">';
          html += '<button id="submitBtn" style="padding:0.7em 2em;font-size:1.1em;margin-right:1em;">ì œì¶œ</button>';
          
          // ë§ˆì§€ë§‰ í”Œë ˆì´ì–´ê°€ ë‚¨ì•˜ëŠ”ì§€ í™•ì¸
          const activePlayers = ordered.filter(p => !p.finished).length;
          if (activePlayers > 1) {
            html += '<button id="passBtn" style="padding:0.7em 2em;font-size:1.1em;">íŒ¨ìŠ¤</button>';
          } else {
            html += '<button id="passBtn" style="padding:0.7em 2em;font-size:1.1em;background:#ccc;color:#666;cursor:not-allowed;" disabled>íŒ¨ìŠ¤ ë¶ˆê°€</button>';
          }
          html += '</div>';
          html += '</div>';
        }

        gameContent.innerHTML = html;

        // 5. ì¹´ë“œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì—°ê²°
        if (myCards && myCards.length > 0) {
           // ì¹´ë“œ ì„ íƒ
          document.querySelectorAll('.cardBtn').forEach(btn => {
            btn.onclick = function() {
              const idx = parseInt(this.getAttribute('data-idx'));
              const clickedCard = myCards[idx];

              if (selected.includes(idx)) { // ì„ íƒ í•´ì œ
                selected = selected.filter(i => i !== idx);
              } else { // ìƒˆë¡œ ì„ íƒ
                if (selected.length === 0) {
                  selected.push(idx);
                } else {
                  const firstCard = myCards[selected[0]];
                  // ì¡°ì»¤ëŠ” ì–´ë–¤ ì¹´ë“œì™€ë„ í•¨ê»˜ ì„ íƒ ê°€ëŠ¥
                  if (clickedCard === 'J' || firstCard === 'J' || clickedCard === firstCard) {
                    selected.push(idx);
                  } else {
                    alert('ê°™ì€ ìˆ«ì ë˜ëŠ” ì¡°ì»¤ë§Œ í•¨ê»˜ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                  }
                }
              }
              renderGame();
            };
          });
          // ì œì¶œ ë²„íŠ¼
          document.getElementById('submitBtn').onclick = function() {
            if (turnInfo && turnInfo.currentPlayer.id !== socket.id) {
              alert('ì•„ì§ ë‚´ ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤!');
              return;
            }
            if (selected.length === 0) {
              alert('ì œì¶œí•  ì¹´ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
              return;
            }
            const cardsToPlay = selected.map(i => myCards[i]);
            socket.emit('playCards', cardsToPlay, (res) => {
              if (res && !res.success) {
                alert(res.message);
              } else {
                // ì„±ê³µ ì‹œ ì„ íƒ í•´ì œ
                selected = [];
              }
            });
          };
          // íŒ¨ìŠ¤ ë²„íŠ¼
          document.getElementById('passBtn').onclick = function() {
            if (turnInfo && turnInfo.currentPlayer.id !== socket.id) {
              alert('ì•„ì§ ë‚´ ì°¨ë¡€ê°€ ì•„ë‹™ë‹ˆë‹¤!');
              return;
            }
            socket.emit('passTurn');
          };
        }
      }

      // ê²Œì„ ì´ˆê¸° ì„¤ì • ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      socket.on('gameSetup', (data) => {
        console.log('Game setup received:', data);
        ordered = data.ordered;
        myCards = data.myCards.sort((a,b) => (a==='J' ? 13 : a) - (b==='J' ? 13 : b));
        turnInfo = data.turnInfo;
        field = data.field;
        myIdx = ordered.findIndex(p => p.id === socket.id);
        selected = [];
        
        renderGame();

        // 5ì´ˆ í›„ì— ìˆ«ì ì •ë³´ ì§€ìš°ê³  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        setTimeout(() => {
            if(ordered && ordered.length > 0) {
              ordered.forEach(p => delete p.card);
              renderGame();
            }
        }, 5000);
      });

      // ì‹ ë¶„ ë° ìë¦¬ ë°°ì • ê²°ê³¼ (ë‹¤ìŒ ë¼ìš´ë“œìš©)
      socket.on('roleAssigned', (newOrdered) => {
        console.log('roleAssigned for next round:', newOrdered);
        ordered = newOrdered;
        myIdx = ordered.findIndex(p => p.id === socket.id);
        // ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ìœ„í•´ ë‹¤ë¥¸ ìƒíƒœ ì´ˆê¸°í™”
        myCards = [];
        selected = [];
        turnInfo = null;
        field = null;
        renderGame();
      });

      // ë‚´ ì¹´ë“œ í‘œì‹œ (ë‹¤ìŒ ë¼ìš´ë“œìš©)
      socket.on('dealCards', (cards) => {
        myCards = cards.sort((a,b) => (a==='J' ? 13 : a) - (b==='J' ? 13 : b));
        selected = [];
        renderGame();
      });

      // ê²Œì„ ì‹œì‘ ì•Œë¦¼ (ë‹¤ìŒ ë¼ìš´ë“œìš©)
      socket.on('gameStarted', (data) => {
        console.log('Game started for next round:', data);
        turnInfo = data;
        renderGame();
      });

      // ì°¨ë¡€ ë³€ê²½ ì•Œë¦¼
      socket.on('turnChanged', (data) => {
        console.log('ì°¨ë¡€ ë³€ê²½:', data);
        turnInfo = data;
        renderGame();
      });

      // ì¹´ë“œ ì œì¶œ ê²°ê³¼
      socket.on('playResult', (data) => {
        console.log('ì¹´ë“œ ì œì¶œ ê²°ê³¼:', data);
        const player = ordered[data.playerIdx];
        const cards = data.cards.map(c => c === 'J' ? 'ğŸƒ' : c).join(' ');

        // í•„ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
        if (data.lastPlay) {
          field = { ...data.lastPlay };
        }

        // ê° í”Œë ˆì´ì–´ì˜ ì¹´ë“œ ìˆ˜ ì—…ë°ì´íŠ¸
        if (data.playerHands) {
          ordered.forEach((p, i) => {
            p.cardCount = data.playerHands[i];
          });
        }

        // ë‚´ê°€ ë‚¸ ì¹´ë“œë©´ ì†ì—ì„œ ì œê±°
        if (player.id === socket.id) {
          data.cards.forEach(card => {
            const index = myCards.indexOf(card);
            if (index > -1) myCards.splice(index, 1);
          });
        }
        
        // ì™„ì£¼í•œ í”Œë ˆì´ì–´ ì²´í¬
        if (data.finished[data.playerIdx]) {
          appendChat(`ğŸ ${player.nickname}ë‹˜ì´ ì™„ì£¼í–ˆìŠµë‹ˆë‹¤!`, false);
        }

        appendChat(`ğŸ´ ${player.nickname}ë‹˜ì´ ${cards}ë¥¼ ëƒˆìŠµë‹ˆë‹¤.`, false);
        renderGame();
      });

      // íŒ¨ìŠ¤ ê²°ê³¼
      socket.on('passResult', (data) => {
        console.log('íŒ¨ìŠ¤ ê²°ê³¼:', data);
        const player = ordered[data.playerIdx];
        appendChat(`â­ï¸ ${player.nickname}ë‹˜ì´ íŒ¨ìŠ¤í–ˆìŠµë‹ˆë‹¤. (${data.passes}ë²ˆì§¸ íŒ¨ìŠ¤)`, false);
      });

      // ìƒˆë¡œìš´ ë¼ìš´ë“œ ì‹œì‘
      socket.on('newRound', (data) => {
        console.log('ìƒˆ ë¼ìš´ë“œ:', data);
        turnInfo = data;
        field = null; // í•„ë“œ ì´ˆê¸°í™”
        appendChat('ğŸ”„ ìƒˆë¡œìš´ ë¼ìš´ë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤!', false);
        renderGame();
      });

      // ê²Œì„ ì¢…ë£Œ ë° ì ìˆ˜
      socket.on('gameEnd', (result) => {
        console.log('ê²Œì„ ì¢…ë£Œ:', result);

        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;

        let html = '<h1 style="text-align:center;">ê²Œì„ ì¢…ë£Œ!</h1>';
        html += '<div style="text-align:center;margin-bottom:2em;">';
        html += '<h2>ğŸ† ì™„ì£¼ ìˆœì„œ</h2>';
        result.forEach((player, i) => {
          const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ…';
          html += `<div style="margin:0.5em 0;font-size:1.1em;">`;
          html += `${medal} ${i + 1}ìœ„: ${player.nickname} (${player.role}) - ${player.score}ì  (ì´ì : ${player.total}ì )`;
          html += '</div>';
        });
        html += '</div>';
        html += '<p style="text-align:center;">ì ì‹œ í›„ ë‹¤ìŒ ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...</p>';
        gameContent.innerHTML = html;

        appendChat('ğŸ‰ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', false);
      });

      // ìµœì¢… ê²°ê³¼ (5íŒ ì™„ë£Œ)
      socket.on('finalResult', (result) => {
        console.log('ìµœì¢… ê²°ê³¼:', result);

        const gameContent = document.getElementById('gameContent');
        if (!gameContent) return;

        let html = '<h1 style="text-align:center;">ğŸŠ ìµœì¢… ê²°ê³¼ ğŸŠ</h1>';
        html += '<div style="text-align:center;margin-bottom:2em;">';
        html += '<h2>ğŸ† ìµœì¢… ìš°ìŠ¹ì</h2>';
        result.forEach((player, i) => {
          const medal = i === 0 ? 'ğŸ‘‘' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : 'ğŸ…';
          html += `<div style="margin:0.5em 0;font-size:1.1em;">`;
          html += `${medal} ${i + 1}ìœ„: ${player.nickname} - ${player.score}ì `;
          html += '</div>';
        });
        html += '</div>';
        html += '<div style="text-align:center;">';
        html += '<button onclick="window.location.href=\'/lobby.html\'" style="padding:1em 2em;font-size:1.2em;background:#4caf50;color:white;border:none;border-radius:8px;cursor:pointer;">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>';
        html += '</div>';

        gameContent.innerHTML = html;

        appendChat('ğŸŠ 5íŒ ì™„ë£Œ! ìµœì¢… ê²°ê³¼ì…ë‹ˆë‹¤!', false);
      });

      // ì±„íŒ… ê¸°ëŠ¥
      const chatMessages = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');
      function appendChat(msg, isMine) {
        const div = document.createElement('div');
        div.textContent = msg;
        div.style.margin = '0.2em 0';
        if (isMine) div.style.textAlign = 'right';
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      chatSend.onclick = sendChat;
      chatInput.onkeydown = function(e) { if (e.key === 'Enter') sendChat(); };
      
      function sendChat() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        socket.emit('chat', msg); // ì„œë²„ë¡œ ë©”ì‹œì§€ ì „ì†¡ë§Œ í•¨
        chatInput.value = '';
      }

      socket.on('chat', (data) => {
        // ì„œë²„ë¡œë¶€í„° ë°›ì€ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
        if (typeof data === 'object' && data.nickname && data.msg) {
            const isMine = data.nickname === nickname;
            const prefix = isMine ? 'ë‚˜' : data.nickname;
            appendChat(`${prefix}: ${data.msg}`, isMine);
        }
      });
    });
  </script>
</body>
</html> 